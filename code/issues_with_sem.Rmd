---
title: "Monte Carlo simulations of infection prevention and control data analysed using structural equation models v3"
author: "Oliver Pearse"
date: "14/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r start, echo = FALSE, warning = FALSE, message = FALSE}

#downloading packages
library(tidyverse)
library(lavaan)
library(mvtnorm)
library(here)
library(gt)

#this function runs the simulation function a certain number of times and collates the results
#it should be used for the functions which have the ability to change individual relationships
sim_sorting_effect <- function(func, reps = 100, size = 52, baseline = 0.2, change_fid = 0.1, change_sepsis = 0.01, sepsis_baseline = 0.5, change_micro = 0.75){
  sim_mult <- do.call("rbind", lapply(X = seq(1:reps), FUN = func, 
                                      baseline = baseline, size = size, 
                                      change_fid = change_fid, change_sepsis = change_sepsis, 
                                      sepsis_baseline = 0.5, change_micro = change_micro))
  sim_mult2 <- lapply(sim_mult, as.numeric)
  fit_mult <- data.frame(
    chisq = c(sum(sim_mult2$chisq < sapply(sim_mult2$df, FUN = prod ,2), na.rm = TRUE) / length(sim_mult2$chisq), 
              sum(sim_mult2$chisq < sapply(sim_mult2$df, FUN = prod ,3) , na.rm = TRUE) / length(sim_mult2$chisq)),
    pvalue = c(sum(sim_mult2$pvalue >= 0.05, na.rm = TRUE) / length(sim_mult2$pvalue), 
               sum(sim_mult2$pvalue >= 0.01, na.rm = TRUE) / length(sim_mult2$pvalue)),
    rmsea = c(sum(sim_mult2$rmsea <= 0.05, na.rm = TRUE) / length(sim_mult2$rmsea), 
              sum(sim_mult2$rmsea <= 0.08, na.rm = TRUE) / length(sim_mult2$rmsea)),
    rmsea.pvalue = c(sum(sim_mult2$rmsea.pvalue > 0.1, na.rm = TRUE) / length(sim_mult2$rmsea.pvalue), 
                     sum(sim_mult2$rmsea.pvalue > 0.05, na.rm = TRUE) / length(sim_mult2$rmsea.pvalue)),
    srmr = c(sum(sim_mult2$srmr <= 0.05, na.rm = TRUE) / length(sim_mult2$srmr), 
             sum(sim_mult2$srmr <= 0.1, na.rm = TRUE) / length(sim_mult2$srmr)),
    nnfi = c(sum(sim_mult2$nnfi >= 0.97, na.rm = TRUE) / length(sim_mult2$nnfi), 
             sum(sim_mult2$nnfi >= 0.95, na.rm = TRUE) / length(sim_mult2$nnfi)),
    cfi = c(sum(sim_mult2$cfi >= 0.97, na.rm = TRUE) / length(sim_mult2$cfi), 
            sum(sim_mult2$cfi >= 0.95, na.rm = TRUE) / length(sim_mult2$cfi)),
    effect = c(mean(sim_mult2$effectall),
               mean(sim_mult2$effectall)),
    good = sum(sim_mult$pass == "Good", na.rm = TRUE) / length(sim_mult$pass),
    acceptable = (sum(sim_mult$pass == "Acceptable", na.rm = TRUE) +  sum(sim_mult$pass == "Good", na.rm = TRUE)) / length(sim_mult$pass),
    change_fid = c(mean(sim_mult2$change_fid), mean(sim_mult2$change_fid)),
    change_micro = c(mean(sim_mult2$change_micro), mean(sim_mult2$change_micro)), 
    change_sepsis = c(mean(sim_mult2$change_sepsis), mean(sim_mult2$change_sepsis)),
    sample_size = c(size, size)
  )
  rownames(fit_mult) <- c("good", "acceptable")
  return(fit_mult)
}

#this function runs the simulation function a certain number of times and collates the results
#it should be used for functions that do not have the ability to change individual relationships
sim_sorting <- function(func, reps = 100, size = 52, baseline = 0.2, change_fid = 0.1, sepsis_baseline = 0.5, change_micro = 1, change_sepsis = 0.01){
  sim_mult <- do.call("rbind", lapply(X = seq(1:reps), FUN = func, 
                                      baseline = baseline, size = size, 
                                      change_fid = change_fid))
  sim_mult2 <- lapply(sim_mult, as.numeric)
  fit_mult <- data.frame(
    chisq = c(sum(sim_mult2$chisq < sapply(sim_mult2$df, FUN = prod ,2), na.rm = TRUE) / length(sim_mult2$chisq), 
              sum(sim_mult2$chisq < sapply(sim_mult2$df, FUN = prod ,3) , na.rm = TRUE) / length(sim_mult2$chisq)),
    pvalue = c(sum(sim_mult2$pvalue >= 0.05, na.rm = TRUE) / length(sim_mult2$pvalue), 
               sum(sim_mult2$pvalue >= 0.01, na.rm = TRUE) / length(sim_mult2$pvalue)),
    rmsea = c(sum(sim_mult2$rmsea <= 0.05, na.rm = TRUE) / length(sim_mult2$rmsea), 
              sum(sim_mult2$rmsea <= 0.08, na.rm = TRUE) / length(sim_mult2$rmsea)),
    rmsea.pvalue = c(sum(sim_mult2$rmsea.pvalue > 0.1, na.rm = TRUE) / length(sim_mult2$rmsea.pvalue), 
                     sum(sim_mult2$rmsea.pvalue > 0.05, na.rm = TRUE) / length(sim_mult2$rmsea.pvalue)),
    srmr = c(sum(sim_mult2$srmr <= 0.05, na.rm = TRUE) / length(sim_mult2$srmr), 
             sum(sim_mult2$srmr <= 0.1, na.rm = TRUE) / length(sim_mult2$srmr)),
    nnfi = c(sum(sim_mult2$nnfi >= 0.97, na.rm = TRUE) / length(sim_mult2$nnfi), 
             sum(sim_mult2$nnfi >= 0.95, na.rm = TRUE) / length(sim_mult2$nnfi)),
    cfi = c(sum(sim_mult2$cfi >= 0.97, na.rm = TRUE) / length(sim_mult2$cfi), 
            sum(sim_mult2$cfi >= 0.95, na.rm = TRUE) / length(sim_mult2$cfi)),
    effect = c(mean(sim_mult2$effectall),
               mean(sim_mult2$effectall)),
    good = sum(sim_mult$pass == "Good", na.rm = TRUE) / length(sim_mult$pass),
    acceptable = (sum(sim_mult$pass == "Acceptable", na.rm = TRUE) +  sum(sim_mult$pass == "Good", na.rm = TRUE)) / length(sim_mult$pass),
    change_fid = c(mean(sim_mult2$change_fid), mean(sim_mult2$change_fid)),
    change_micro = c(mean(sim_mult2$change_micro), mean(sim_mult2$change_micro)), 
    change_sepsis = c(mean(sim_mult2$change_sepsis), mean(sim_mult2$change_sepsis))
  )
  rownames(fit_mult) <- c("good", "acceptable")
  return(fit_mult)
}

#takes the data from a list of outputs from sim_sorting and extracts the relevant datapoints
extractor <- function(data){
  all_data <- data.frame()
  for (i in 1:length(data)){
    name <- names(data[i])
    chip_good <- data[[i]][1, 2]
    chip_acc <- data[[i]][2, 2]
    rmsea_good <- data[[i]][1, 3]
    rmsea_acc <- data[[i]][2, 3]
    srmr_good <- data[[i]][1, 5]
    srmr_acc <- data[[i]][2, 5]
    nnfi_good <- data[[i]][1, 6]
    nnfi_acc <- data[[i]][2, 6]
    cfi_good <- data[[i]][1, 7]
    cfi_acc <- data[[i]][2, 7]
    effect <- data[[i]][1, 8]
    good <- data[[i]][1, 9]
    acceptable <- data[[i]][1, 10]
    first_data <- data.frame(name = name,
                              chip_good = chip_good,
                              chip_acc = chip_acc,
                              rmsea_good = rmsea_good,
                              rmsea_acc = rmsea_acc,
                              srmr_good = srmr_good,
                              srmr_acc = srmr_acc,
                              nnfi_good = nnfi_good,
                              nnfi_acc = nnfi_acc,
                              cfi_good = cfi_good,
                              cfi_acc = cfi_acc,
                              effect = effect,
                              overall_good = good,
                              overall_acceptable = acceptable
                             )
    all_data <- rbind(all_data, first_data)                
  }
  all_data2 <- all_data %>%
    separate(name, c("change_fid", "sample_size"), sep = "_") %>%
    mutate(change_fid = as.numeric(substr(change_fid, 2, nchar(change_fid))),
           sample_size = as.numeric(sample_size)) %>%
    pivot_longer(cols = c("chip_good",
                          "chip_acc",
                          "rmsea_good",
                          "rmsea_acc",
                          "srmr_good",
                          "srmr_acc",
                          "nnfi_good",
                          "nnfi_acc",
                          "cfi_good",
                          "cfi_acc",
                          "overall_good",
                          "overall_acceptable"),
                 names_to = "fit_measures",
                 values_to = "prop_passing") %>%
    mutate(effect = effect * -100)
  #separate(prop_passing, c("measure", "goodness_of_fit", sep = "_"))
  return(all_data2)
}

#plots extracted data
plotter <- function(data){
  ggplot(data = data, aes(x = effect, y = prop_passing, colour = sample_size)) +
    geom_point(position = position_jitter(width = 0.05, height = 0.05)) +
    ylim(-0.1, 1.1) +
    xlab("% change in sepsis rates as a result of intervention") +
    ylab("% simulations fitting (either acceptable or good fit)") +
    facet_wrap(~fit_measures, ncol = 2,
                   labeller = labeller(fit_measures = 
                                        c("cfi_acc" = "CFI, acceptable fit",
                                        "cfi_good" = "CFI, good fit",
                                        "chip_acc" = "Chi squared, acceptable fit",
                                        "chip_good" = "Chi square, good fit",
                                        "nnfi_acc" = "NNFI, acceptable fit",
                                        "nnfi_good" = "NNFI, good fit",
                                        "overall_acceptable" = "Overall, acceptable fit",
                                        "overall_good" = "Overall, good fit",
                                        "rmsea_acc" = "RMSEA, acceptable fit",
                                        "rmsea_good" = "RMSEA, good fit",
                                        "srmr_acc" = "SRMR, acceptable fit",
                                        "srmr_good" = "SRMR, good fit"))) +
    scale_color_viridis_c(option = "C", direction = -1,
                          name = "Sample size (weeks)")
}

#plots extracted data
plotter2 <- function(data){
  ggplot(data = data, aes(x = sample_size, y = prop_passing)) +
    geom_point() +
    ylim(-0.1, 1.1) +
    xlab("Sample size") +
    ylab("% simulations fitting (either acceptable or good fit)") +
    facet_wrap(~fit_measures, ncol = 2,
                   labeller = labeller(fit_measures = 
                                        c("cfi_acc" = "CFI, acceptable fit",
                                        "cfi_good" = "CFI, good fit",
                                        "chip_acc" = "Chi squared, acceptable fit",
                                        "chip_good" = "Chi square, good fit",
                                        "nnfi_acc" = "NNFI, acceptable fit",
                                        "nnfi_good" = "NNFI, good fit",
                                        "overall_acceptable" = "Overall, acceptable fit",
                                        "overall_good" = "Overall, good fit",
                                        "rmsea_acc" = "RMSEA, acceptable fit",
                                        "rmsea_good" = "RMSEA, good fit",
                                        "srmr_acc" = "SRMR, acceptable fit",
                                        "srmr_good" = "SRMR, good fit"))) +
    scale_color_viridis_c(option = "C", direction = -1,
                          name = "Sample size (weeks)")
}

#runs a number of simulations for different scenarios and turns the data into
#a list
runit <- function(func){
  
  #nine months
  sim_0_39 <- sim_sorting(func = func, reps = 100, change_fid = 0, size = 39)
  sim_1_39 <- sim_sorting(func = func, reps = 100, change_fid = 0.01, size = 39)
  sim_2_39 <- sim_sorting(func = func, reps = 100, change_fid = 0.025, size = 39)
  sim_4_39 <- sim_sorting(func = func, reps = 100, change_fid = 0.04, size = 39)
  sim_6_39 <- sim_sorting(func = func, reps = 100, change_fid = 0.06, size = 39)
  sim_9_39 <- sim_sorting(func = func, reps = 100, change_fid = 0.09, size = 39)

  
  #one year
  sim_0_52 <- sim_sorting(func = func, reps = 100, change_fid = 0, size = 52)
  sim_1_52 <- sim_sorting(func = func, reps = 100, change_fid = 0.01, size = 52)
  sim_2_52 <- sim_sorting(func = func, reps = 100, change_fid = 0.025, size = 52)
  sim_4_52 <- sim_sorting(func = func, reps = 100, change_fid = 0.04, size = 52)
  sim_6_52 <- sim_sorting(func = func, reps = 100, change_fid = 0.06, size = 52)
  sim_9_52 <- sim_sorting(func = func, reps = 100, change_fid = 0.09, size = 52)

  #18 months
  sim_0_78 <- sim_sorting(func = func, reps = 100, change_fid = 0, size = 78)
  sim_1_78 <- sim_sorting(func = func, reps = 100, change_fid = 0.01, size = 78)
  sim_2_78 <- sim_sorting(func = func, reps = 100, change_fid = 0.025, size = 78)
  sim_4_78 <- sim_sorting(func = func, reps = 100, change_fid = 0.04, size = 78)
  sim_6_78 <- sim_sorting(func = func, reps = 100, change_fid = 0.06, size = 78)
  sim_9_78 <- sim_sorting(func = func, reps = 100, change_fid = 0.09, size = 78)


  #four years
  sim_0_208 <- sim_sorting(func = func, reps = 100, change_fid = 0, size = 208)
  sim_1_208 <- sim_sorting(func = func, reps = 100, change_fid = 0.01, size = 208)
  sim_2_208 <- sim_sorting(func = func, reps = 100, change_fid = 0.025, size = 208)
  sim_4_208 <- sim_sorting(func = func, reps = 100, change_fid = 0.04, size = 208)
  sim_6_208 <- sim_sorting(func = func, reps = 100, change_fid = 0.06, size = 208)
  sim_9_208 <- sim_sorting(func = func, reps = 100, change_fid = 0.09, size = 208)

  sim_data <- list(s0_39 = sim_0_39, 
                 s1_39 = sim_1_39, 
                 s2_39 = sim_2_39, 
                 s4_39 = sim_4_39, 
                 s6_39 = sim_6_39,
                 s9_39 = sim_9_39,
                 s0_52 = sim_0_52, 
                 s1_52 = sim_1_52, 
                 s2_52 = sim_2_52, 
                 s4_52 = sim_4_52, 
                 s6_52 = sim_6_52,
                 s9_52 = sim_9_52,
                 s0_78 = sim_0_78, 
                 s1_78 = sim_1_78, 
                 s2_78 = sim_2_78, 
                 s4_78 = sim_4_78, 
                 s6_78 = sim_6_78,
                 s9_78 = sim_9_78,
                 s0_208 = sim_0_208, 
                 s1_208 = sim_1_208, 
                 s2_208 = sim_2_208, 
                 s4_208 = sim_4_208, 
                 s6_208 = sim_6_208,
                 s9_208 = sim_9_208)
  
  return(sim_data)
}

#runs a number of different scenarios that mess with the effect sizes and collates the data
runeffect <- function(func){
  #small effect is 5, mod effect is 10, large effect is 15
 fid_vect <- c(rep(0.05, 9),
          rep(0.10, 9),
          rep(0.15, 9))
 micro_vect <- rep(c(0.25, 0.25, 0.25,
                      0.5, 0.5, 0.5,
                      0.75, 0.75, 0.75), 3)
 sepsis_vect = rep(c(0.005, 0.01, 0.015), 9)
  
 all_runs <- mapply(FUN = sim_sorting_effect, 
                    change_fid = fid_vect, 
                    change_micro = micro_vect,
                    change_sepsis = sepsis_vect,
                    MoreArgs = list(reps = 100, size = 52, func = sem_env_effects))
 
  all_data <- data.frame()
  for (i in 1:ncol(all_runs)){
    #name <- names(data[i])
    chip_good <- all_runs[2, ][[i]][1]
    chip_acc <- all_runs[2, ][[i]][2]
    rmsea_good <- all_runs[3, ][[i]][1]
    rmsea_acc <- all_runs[3, ][[i]][2]
    srmr_good <- all_runs[5, ][[i]][1]
    srmr_acc <- all_runs[5, ][[i]][2]
    nnfi_good <- all_runs[6, ][[i]][1]
    nnfi_acc <- all_runs[6, ][[i]][2]
    cfi_good <- all_runs[7, ][[i]][1]
    cfi_acc <- all_runs[7, ][[i]][2]
    effect <- all_runs[8, ][[i]][1]
    good <- all_runs[9, ][[i]][1]
    acceptable <- all_runs[10, ][[i]][1]
    change_fid <- all_runs[11, ][[i]][1]
    change_micro <- all_runs[12, ][[i]][1]
    change_sepsis <- all_runs[13, ][[i]][1]
    sample_size <- all_runs[14, ][[i]][1]
    first_data <- data.frame( chip_good = chip_good,
                              chip_acc = chip_acc,
                              rmsea_good = rmsea_good,
                              rmsea_acc = rmsea_acc,
                              srmr_good = srmr_good,
                              srmr_acc = srmr_acc,
                              nnfi_good = nnfi_good,
                              nnfi_acc = nnfi_acc,
                              cfi_good = cfi_good,
                              cfi_acc = cfi_acc,
                              effect = effect,
                              overall_good = good,
                              overall_acceptable = acceptable,
                              change_fid = change_fid,
                              change_micro = change_micro,
                              change_sepsis = change_sepsis,
                              sample_size = sample_size
                             )
    all_data <- rbind(all_data, first_data)                
  }
  all_data2 <- cbind(fid_vect, micro_vect, sepsis_vect, all_data)
  all_data3 <- all_data2 %>%
    pivot_longer(cols = c("chip_good",
                          "chip_acc",
                          "rmsea_good",
                          "rmsea_acc",
                          "srmr_good",
                          "srmr_acc",
                          "nnfi_good",
                          "nnfi_acc",
                          "cfi_good",
                          "cfi_acc",
                          "overall_good",
                          "overall_acceptable"),
                 names_to = "fit_measures",
                 values_to = "prop_passing") %>%
    mutate(effect = effect * -100)
  #separate(prop_passing, c("measure", "goodness_of_fit", sep = "_"))
  return(all_data3)
}

#setting some defaults
size = 52; baseline = 0.2; change_fid = 0.1; change_micro = 0.75; change_sepsis = 0.01; sepsis_baseline = 0.5
  
```

Need to sort out:

- Is micro scale accurate?
- Change it so that alpha + beta can be changed (optional)
- Put a floor on sepsis - so that it is limited to approx 5% for example
- Add comments to the code
- Go through all the questions and model them

## Research questions

 1) Do IPC interventions have an effect on sepsis? If so, which ones? And how much? 
      a) Linear regression of IPC interventions on sepsis
 2) Is the cleanliness of specific ward "areas" more closely associated with the risk of sepsis? Is the cleanliness of specific ward "areas" more closely associated with specific IPC interventions? 
      a) SEM with dropping out of different areas
 3) Are measures of IPC fidelity adequate for understanding how well protected babies are from sepsis? 
      a) PGFI/AIC of models including microbiology, fidelity or IPC
 4) Are there specific fidelity or microbiology thresholds we should be aiming for?
      a) Work back from SEM results. Aim for a specific HAI rate then work back to fidelity and microbiology. 
      b) Linear regression with fitted splines? 
      
## Decision rules for accepting models

I will look at the following fit metrics to determine whether the models have good or acceptable fit for the data. 

Good fit: 
 
	Chi squared p value ≥ 0.05
	AND
	RMSEA ≤ 0.05 AND SRMR ≤ 0.1 OR SRMR ≤ 0.05 AND RMSEA ≤ 0.1
	AND
	CFI ≥ 0.97 AND NNFI ≥ 0.9 OR NNFI ≥ 0.97 AND CFI ≥ 0.9

 
Acceptable fit:

	Chi squared p value ≥ 0.01
	AND
	RMSEA ≤ 0.08 AND SRMR ≤ 0.1 OR SRMR ≤ 0.08 AND RMSEA ≤ 0.1
	AND
	CFI ≥ 0.95 AND NNFI ≥ 0.9 OR NNFI ≥ 0.95 AND CFI ≥ 0.9
	
Though the following measures won't be used to determine whether the model fits or not, I will also report the Chi-squared, with degrees of freedom and p value, the RMSEA with it's interval and the PNFI. 
	
The most stringent accepted fit metrics are: 

 - Chi squared p value - >= 0.05 (good), >= 0.01 (acceptable)
 - RMSEA - <= 0.05 (good), <= 0.08 (acceptable)
 - SRMR - <= 0.05 (good), <= 0.1 (acceptable)
 - CFI - >= 0.97 (good), >= 0.95 (acceptable)
 - NNFI - >= 0.97 (good), >= 0.95 (acceptable)

However, some investigators use less stringent metrics. 

### Changing effect size on the proportion of simulations that are accepted

There are 3 layers of effect. 

C = change

1) IPC interventions on fidelity

The effect of IPC interventions on fidelity were simulated by an $rbeta$ distribution. 

The mean of the rbeta distribution for any given values of $\alpha$ and $\beta$ is calculated by:

$$E[X_{fid}] = \frac{\alpha_{fid}}{\alpha_{fid} + \beta_{fid}}$$

$\alpha$ is a vector of numbers, calculated by the following equation. 

$$ \alpha_i = 10(C_{fid}(int_{1i} + int_{2i} + int_{3i}) + B_{fid})  $$
Where $C_{fid}$ represents the desired change in fidelity from changing an intervention from the 0 to 1 state (off to on) and $B_{fid}$ represents the pre-specified baseline fidelity. $int_{xi}$ represent vectors representing whether each interventions is in the on or off state. $\beta_{fid}$ is calculated as $10 - \alpha_{fid}$. 

2) Fidelity on microbiology

The effect of changes in fidelity on microbiology is simulated as a $multivariate \hspace{0.2cm}normal$ distribution with the following parameters describing the means of the distribution. The equation below is repeated for each microbiological "area". The value for each area is then calculated using the $multivariate \hspace{0.2cm}normal$ distribution.

$$E[X_{mic}] = \alpha_{mic} -\beta_{mic}f_{mic} $$
$\alpha_{mic$ represents the maximum value for the microbiology, and is set at 15, which is the approximate value for the highest $log(m)$ values that we are likely to find. The effect of changes in fidelity can be altered by changing the value of $\beta_{mic}$. The variance/covariance matrix $(\sigma)$ is set so that the diagonals are  1 and the off-diagonals are 0.5. 

3) Microbiology on sepsis

This is also simulated using an $rbeta$ distribution where $\alpha_{sep}$ and $\beta_{sep}$ are defined as:

$$\alpha_{sep} = \alpha_0 - (\alpha_0 + \beta_0) \times  \delta $$
$$\beta_{sep} = \beta_0 + (\alpha_0 + \beta_0) \times \delta $$
Where $ \delta = C_{sep} \times D_{mic}$, $ \alpha_0 = B_{sep} \times 100$ and $ \beta_0 = 100 - \alpha_0 $. 

$D_{mic}$ is a vector represented by $max_{mic} - micro_i$ where $micro_i$ is a vector of all microbiology values for every area combined by addition and $max_{mic}$ is the largest value of $micro_i$. $C_{sep}$ represents the desired change in the proportion of neonates with sepsis from a 1 log drop in all microbiology parameters, and $B_{sep}$ represents the pre-specified baseline level of sepsis. 


```{r effect size, echo = FALSE, warning = FALSE, message = FALSE}
#simulating data ----
sem_env_effects <- function(x, size = 52, baseline = 0.2, change_fid = 0.1, change_micro = 0.75, sepsis_baseline = 0.5, change_sepsis = 0.01){
  
  mv_2 <- function(x, y, sigma = sigma_2, mv_scale = change_micro, ...){
    mv_scale <- 15 * mv_scale
    param <- rmvnorm(n = 1, mean = c(15 - x * mv_scale, 15 - y * mv_scale), sigma = sigma_2) 
    #param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(1, 0.5, 
                      0.5, 1), ncol = 2)
  
  mv_3 <- function(x, y, z, sigma = sigma_3, mv_scale = change_micro, ...){
    mv_scale <- 15 * mv_scale
    param <- rmvnorm(n = 1, mean = c(15 - x * mv_scale, 15 - y * mv_scale, 
                                     15 - z * mv_scale), sigma = sigma_3)
    #param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(1, 0.5, 0.5, 
                        0.5, 1, 0.5, 
                        0.5, 0.5, 1), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  alpha_hands <- ((int_h1 + int_h2 + int_h3) * change_fid + baseline) * 10
  alpha_hands[alpha_hands<0] <- 0
  alpha_hands[alpha_hands>10] <- 10
  beta_hands <- 10 - alpha_hands
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  alpha_env <- ((int_e1 + int_e2 + int_e3) * change_fid + baseline) * 10
  alpha_env[alpha_env<0] <- 0
  alpha_env[alpha_env>10] <- 10
  beta_env <- 10 - alpha_env

  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, alpha_env, beta_env)
  fid_floor <- rbeta(size, alpha_env, beta_env)
  fid_surf <- rbeta(size, alpha_env, beta_env)
  #hands
  fid_mat <- rbeta(size, alpha_hands, beta_hands)
  fid_staff <- rbeta(size, alpha_hands, beta_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   z = fid_surf, MoreArgs = list(sigma = sigma_3, mv_scale = change_micro))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]

  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, 
                     MoreArgs = list(sigma = sigma_2, mv_scale = change_micro))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #this allows sepsis to be scaled and a baseline decided upon
  all_micro <- micro_cot + micro_floor + micro_surf + micro_staff + micro_mat
  max_micro <- max(all_micro)
  #baseline alpha
  alpha0 <- sepsis_baseline * 100
  #baseline beta
  beta0 <- 100 - alpha0
  #change in micro relative to baseline
  microD <- max_micro - all_micro
  #delta
  delta <- change_sepsis * microD
  #alpha to use
  alpha_sepsis <- alpha0 - (alpha0 + beta0) * delta
  alpha_sepsis[alpha_sepsis < 0] <- 0
  #beta to use
  beta_sepsis <- beta0 + (alpha0 + beta0) * delta
  beta_sepsis[beta_sepsis < 0] <- 0
  #sepsis
  sepsis <- rbeta(size, alpha_sepsis, beta_sepsis)
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4])),
                           change_fid = change_fid,
                           change_micro = change_micro,
                           change_sepsis = change_sepsis
  ))
  rownames(data) <- c()
  return(data)
}


#this function runs the simulator for different parameters
data_effects <- runeffect(sem_env_effects)

effects <- data_effects %>%
  filter(fit_measures == "overall_good") %>%
  mutate(change_micro = as.character(change_micro)) %>%
  mutate(change_fid = 100 * change_fid,
         change_sepsis = change_sepsis)

effects_acc <- data_effects %>%
  filter(fit_measures == "overall_acceptable") %>%
  mutate(change_micro = as.character(change_micro))

ggplot(data = effects, aes(x = change_micro, y = change_fid, fill = prop_passing)) +
  geom_tile() +
  facet_grid( ~ change_sepsis) +
  scale_fill_viridis_c(option = "C",
                       name = "Proportion of simulations accepted") +
  ylab("Effect of changing intervention on fidelity") +
  xlab("Effect of changing fidelity on microbiology")

plotter(data_effects)


```

The effect of changing intervention on fidelity (y axis) represents the % change in fidelity based on switching a single intervention from off to on. 

The effect of changing fidelity on microbiology (x axis) represents the log drop in microbiology based on a 10% increase in fidelity in a single area. 

The effect of changing microbiology on sepsis (facets) represents the % change in sepsis based on a 1 log drop in all areas of microbiology.

### Plotting a time series of the variables for interest

```{r time series, echo = FALSE, warning = FALSE}

sim_timeseries <- function(reps = 100, size = 52, baseline = 0.2, change_fid = 0.1, change_micro = 0.5, change_sepsis = 0.01, sepsis_baseline = 0.5){
  
  mv_2 <- function(x, y, sigma = sigma_2, mv_scale = change_micro, ...){
    mv_scale <- 15 * mv_scale
    param <- rmvnorm(n = 1, mean = c(15 - x * mv_scale, 15 - y * mv_scale), sigma = sigma_2) 
    #param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(1, 0.5, 
                      0.5, 1), ncol = 2)
  
  mv_3 <- function(x, y, z, sigma = sigma_3, mv_scale = change_micro, ...){
    mv_scale <- 15 * mv_scale
    param <- rmvnorm(n = 1, mean = c(15 - x * mv_scale, 15 - y * mv_scale, 
                                     15 - z * mv_scale), sigma = sigma_3)
    #param <- round(param)
    return(param)
  }
  
  sigma_3 <- matrix(c(1, 0.5, 0.5, 
                      0.5, 1, 0.5, 
                      0.5, 0.5, 1), ncol = 3)
  
  fidcot_all <- data.frame()
  fidfloor_all <- data.frame()
  fidsurf_all <- data.frame()
  fidmat_all <- data.frame()
  fidstaff_all <- data.frame()
  microcot_all <- data.frame()
  microfloor_all <- data.frame()
  microsurf_all <- data.frame()
  micromat_all <- data.frame()
  microstaff_all <- data.frame()
  sepsis_all <- data.frame()
  for(i in 1:reps){
    #simulating time
      #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  alpha_hands <- ((int_h1 + int_h2 + int_h3) * change_fid + baseline) * 10
  alpha_hands[alpha_hands<0] <- 0
  alpha_hands[alpha_hands>10] <- 10
  beta_hands <- 10 - alpha_hands
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  alpha_env <- ((int_e1 + int_e2 + int_e3) * change_fid + baseline) * 10
  alpha_env[alpha_env<0] <- 0
  alpha_env[alpha_env>10] <- 10
  beta_env <- 10 - alpha_env

  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, alpha_env, beta_env)
  fid_floor <- rbeta(size, alpha_env, beta_env)
  fid_surf <- rbeta(size, alpha_env, beta_env)
  #hands
  fid_mat <- rbeta(size, alpha_hands, beta_hands)
  fid_staff <- rbeta(size, alpha_hands, beta_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   z = fid_surf, MoreArgs = list(sigma = sigma_3, mv_scale = change_micro))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]

  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, 
                     MoreArgs = list(sigma = sigma_2, mv_scale = change_micro))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #this allows sepsis to be scaled and a baseline decided upon
  all_micro <- micro_cot + micro_floor + micro_surf + micro_staff + micro_mat
  max_micro <- max(all_micro)
  #baseline alpha
  alpha0 <- sepsis_baseline * 100
  #baseline beta
  beta0 <- 100 - alpha0
  #change in micro relative to baseline
  microD <- max_micro - all_micro
  #delta
  delta <- change_sepsis * microD
  #alpha to use
  alpha_sepsis <- alpha0 - (alpha0 + beta0) * delta
  alpha_sepsis[alpha_sepsis < 0] <- 0
  #beta to use
  beta_sepsis <- beta0 + (alpha0 + beta0) * delta
  beta_sepsis[beta_sepsis < 0] <- 0
  #sepsis
  sepsis <- rbeta(size, alpha_sepsis, beta_sepsis)
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
    fidcot_all <- rbind(fidcot_all, fid_cot)
    fidfloor_all <- rbind(fidfloor_all, fid_floor)
    fidsurf_all <- rbind(fidsurf_all, fid_surf)
    fidmat_all <- rbind(fidmat_all, fid_mat)
    fidstaff_all <- rbind(fidstaff_all, fid_staff)
    microcot_all <- rbind(microcot_all, micro_cot)
    microfloor_all <- rbind(microfloor_all, micro_floor)
    microsurf_all <- rbind(microsurf_all, micro_surf)
    micromat_all <- rbind(micromat_all, micro_mat)
    microstaff_all <- rbind(microstaff_all, micro_staff)
    sepsis_all <- rbind(sepsis_all, sepsis)
  }
  fidcot_stats <- sapply(fidcot_all, FUN = quantile)
  fidcot_stats2 <- as.data.frame(t(fidcot_stats))
  microcot_stats <- sapply(microcot_all, FUN = quantile)
  microcot_stats2 <- as.data.frame(t(microcot_stats)) / 15
  sepsis_stats <- sapply(sepsis_all, FUN = quantile)
  sepsis_stats2 <- as.data.frame(t(sepsis_stats))
  interventions <- c(Position(function(x) x > 0, int_h1),
                     Position(function(x) x > 0, int_h2),
                     Position(function(x) x > 0, int_h3),
                     Position(function(x) x > 0, int_e1),
                     Position(function(x) x > 0, int_e2),
                     Position(function(x) x > 0, int_e3))
  ggplot() + 
    geom_line(data = fidcot_stats2, aes(y = `50%`, x = seq(1:52)), colour = "black") + 
    geom_ribbon(data = fidcot_stats2, aes(ymin = `25%`, ymax = `75%`, x = seq(1:52)), alpha = 0.5, fill = "black") + 
    geom_line(data = microcot_stats2, aes(y = `50%`, x = seq(1:52)), colour = "blue") + 
    geom_ribbon(data = microcot_stats2, aes(ymin = `25%`, ymax = `75%`, x = seq(1:52)), alpha = 0.5, fill = "blue") +
    geom_line(data = sepsis_stats2, aes(y = `50%`, x = seq(1:52)), colour = "red") + 
    geom_ribbon(data = sepsis_stats2, aes(ymin = `25%`, ymax = `75%`, x = seq(1:52)), alpha = 0.5, fill = "red") +
    geom_vline(xintercept = interventions) +
    scale_y_continuous(name = "Proportion fidelity of cleanliness and neonates with sepsis", limits = c(0, 1),
                       sec.axis = sec_axis(trans=~.*15, name = "Microbiology"))
}

sim_timeseries(reps = 1000)
  
  
```

This time series illustrates how the data that we are simulating looks. 

### This is the basic model for environmental SEM

```{r complex, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
#simulating data ----
sem_env_basic <- function(x, size = 52, baseline = 20, fid_scale = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(20, 10, 
                      10, 20), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(20, 10, 10, 
                        10, 20, 10, 
                        10, 10, 20), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * fid_scale + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * fid_scale + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot, micro_floor, micro_surf, micro_staff, micro_mat)) * 5
  prop <- (micro_cot + micro_floor + micro_surf + micro_staff + micro_mat) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


#this function runs the simulator for different parameters
list_env <- runit(sem_env_basic)

#this function extracts the data from it
data_env <- extractor(list_env)

#this function plots the data
plotter(data_env)

```


### Question 1: Do IPC interventions have an effect on sepsis? If so which ones? And how much? 

We will fit an SEM model as illustrated above. However, alongside this we will also perform a standard linear regression of different IPC measures against sepsis. This will tell us the relationship between such measures and the rates of sepsis. 


### Question 2: Is the cleanliness of specific ward "areas" more closely associated with the risk of sepsis? Is the cleanliness of specific ward "areas" more closely associated with specific IPC interventions? 

Looking at this would allow us to determine which areas are most useful for intervention. If specific ward areas are most associated with sepsis and it is clear which interventions affect these primarily, then these areas can be targeted with interventions that are most likely to be effective.

To determine how well the model will be at identifying individual ward areas as responsible for decreases in sepsis I will alter some of the relationships in the model. 

#### First a model where only one area has an effect on sepsis. 

In this model, only cot contamination has any effect on sepsis. All other variables have no effect. 

```{r one area, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
#simulating data ----
sem_env_onearea <- function(x, size = 52, baseline = 20, fid_scale = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(4, 2, 
                      2, 4), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(4, 2, 2, 
                        2, 4, 2, 
                        2, 2, 4), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * fid_scale + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * fid_scale + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot))
  prop <- (micro_cot) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


sim_onearea <- runit(sem_env_onearea)

data_env <- extractor(sim_onearea)

plotter(data_env)

```

It looks therefore like specifying relationships that are not there will not lead to the model being rejected, however the magnitude of the coefficients will show whether there is a meaningful effect or not. In this example this is illustrated by the magnitude of effect between micro_cot and sepsis  (variable for which there is a simulated relationship) and micro_surf and sepsis (variable for which there is no simulated relationship).

#### Next a model where only one IPC intervention has any relationships

In this model, only one IPC intervention has any effect on fidelity.

```{r one ipc, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
#simulating data ----
sem_env_oneipc <- function(x, size = 52, baseline = 20, fid_scale = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(4, 2, 
                      2, 4), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(4, 2, 2, 
                        2, 4, 2, 
                        2, 2, 4), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * fid_scale + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e2) * fid_scale + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot))
  prop <- (micro_cot) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


sim_oneipc <- runit(sem_env_oneipc)

data_oneipc <- extractor(sim_oneipc)

plotter(data_oneipc)

```



### Question 3: Are measures of IPC fidelity adequate for understanding how well protected babies are from sepsis?


### Question 4: Are there specific fidelity or microbiology thresholds we should be aiming for?


### This is a simulation of a model that is completely independent

There are no relationships between any of the variables for this model, however, certain fit measures accept it. If you use the decision rule for overall passing or failing though, it is never accepted. That is why it is important to retain all of the fit measures when judging the models. 

``` {r  completely independent model,  echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

#simulating data ----
sem_env_ci <- function(x, size = 52, baseline = 20, fid_scale = 10){

  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * fid_scale + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, 50, 50)
  fid_floor <- rbeta(size, 50, 50)
  fid_surf <- rbeta(size, 50, 50)
  #hands
  #microbiology
  #environmental
  micro_cot <- round(rnorm(size, mean = 50, sd = 2))
  micro_floor <- round(rnorm(size, mean = 50, sd = 2))
  micro_surf <- round(rnorm(size, mean = 50, sd = 2))
  micro_staff <- round(rnorm(size, mean = 50, sd = 2))
  micro_mat <- round(rnorm(size, mean = 50, sd = 2))
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  prop <- 0.3
  sepsis <- rbinom(size, num, prop) / num

  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    #int_h1 = int_h1,
    #int_h2 = int_h2,
    #int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    #fid_mat = fid_mat,
    #fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}

#one year
sim_2_52_ci <- sim_sorting(func = sem_env_ci, reps = 100, fid_scale = 2)

#18 months
sim_2_78_ci <- sim_sorting(func = sem_env_ci, reps = 100, fid_scale = 2, size = 78)


#four years
sim_2_208_ci <- sim_sorting(func = sem_env_ci, reps = 100, fid_scale = 2, size = 208)

sim_data_ci <- list(s2_52 = sim_2_52_ci, 
                 s2_78 = sim_2_78_ci, 
                 s2_208 = sim_2_208_ci)

data_ci <- extractor(sim_data_ci)

plotter2(data_ci)

```

#### This model has mis-specified relationships

``` {r completely independent misspecified,  echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}

#simulating data ----
sem_env_mis <- function(x, size = 52, baseline = 20, fid_scale = 10){
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  a1 <- rnorm(size, 50, 10)
  a2 <- rnorm(size, 50, 10)
  a3 <- rnorm(size, 50, 10)
  a4 <- rnorm(size, 50, 10)
  
  b1 <- a1 + rnorm(size, 0, 1)
  b2 <- a2 + rnorm(size, 0, 1)
  b3 <- a3 + rnorm(size, 0, 1)
  b4 <- a4 + rnorm(size, 0, 1)
  
  c1 <- rnorm(size, 50, 10)
  c2 <- rnorm(size, 50, 10)
  c3 <- rnorm(size, 50, 10)
  c4 <- rnorm(size, 50, 10)
  
  s1 <- rnorm(size, 50, 10)
  
  
  
  #creating data frame
  df_ipc <- data.frame(
    a1 = a1,
    a2 = a2,
    a3 = a3,
    a4 = a4,
    b1 = b1,
    b2 = b2,
    b3 = b3,
    b4 = b4,
    c1 = c1, 
    c2 = c2,
    c3 = c3,
    c4 = c4,
    s1 = s1
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    b1 ~ a2
    b2 ~ a1
    b3 ~ b4
    b4 ~ b3
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  #effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2))
  rownames(data) <- c()
  return(data)
}

#one year
sim_52_mis <- sim_sorting(func = sem_env_mis, reps = 100)

#18 months
sim_78_mis <- sim_sorting(func = sem_env_mis, reps = 100,size = 78)

#four years
sim_208_mis <- sim_sorting(func = sem_env_mis, reps = 100, size = 208)

sim_data_mis <- list(s_52 = sim_52_mis,
                    s_78 = sim_78_mis,
                    s_208 = sim_208_mis)

data_mis <- extractor(sim_data_mis)

plotter2(data_mis)
```


### Notes

 - Can't have covariance relationship between micro_mat and micro_staff as theses are exogenous variables and lavaan is unable to estimate the covariance relationship between them. Can either leave that relationship out or use fixed.x = FALSE
 - If linear regression of covariates against outcome has autocorrelation after accounting for the covariates (eg some time trends), then splines for time trends will need to be added to account for this, as variables are supposed to be independent conditioning on explanatory variables
 - Think about modelling time dependent decay
      - Model time dependent decay in the simulations
      - In the analysis can look at time since intervention - an asymptotic or linear decay function to see how quickly the effects of interventions decay

