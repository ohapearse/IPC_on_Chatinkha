---
title: "Monte Carlo simulations of infection prevention and control data analysed using structural equation models v3"
author: "Oliver Pearse"
date: "14/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r start, echo = FALSE, warning = FALSE, message = FALSE}

library(tidyverse)
library(lavaan)
library(mvtnorm)
library(here)
library(gt)

sim_sorting <- function(func, reps = 100, size = 52, baseline = 20, mag = 10, sepsis_scale = 1, micro_scale = 1){
  sim_mult <- do.call("rbind", lapply(X = seq(1:reps), FUN = func, 
                                      baseline = baseline, size = size, 
                                      mag = mag, sepsis_scale = sepsis_scale, micro_scale = micro_scale))
  sim_mult2 <- lapply(sim_mult, as.numeric)
  fit_mult <- data.frame(
    chisq = c(sum(sim_mult2$chisq < sapply(sim_mult2$df, FUN = prod ,2), na.rm = TRUE) / length(sim_mult2$chisq), 
              sum(sim_mult2$chisq < sapply(sim_mult2$df, FUN = prod ,3) , na.rm = TRUE) / length(sim_mult2$chisq)),
    pvalue = c(sum(sim_mult2$pvalue >= 0.05, na.rm = TRUE) / length(sim_mult2$pvalue), 
               sum(sim_mult2$pvalue >= 0.01, na.rm = TRUE) / length(sim_mult2$pvalue)),
    rmsea = c(sum(sim_mult2$rmsea <= 0.05, na.rm = TRUE) / length(sim_mult2$rmsea), 
              sum(sim_mult2$rmsea <= 0.08, na.rm = TRUE) / length(sim_mult2$rmsea)),
    rmsea.pvalue = c(sum(sim_mult2$rmsea.pvalue > 0.1, na.rm = TRUE) / length(sim_mult2$rmsea.pvalue), 
                     sum(sim_mult2$rmsea.pvalue > 0.05, na.rm = TRUE) / length(sim_mult2$rmsea.pvalue)),
    srmr = c(sum(sim_mult2$srmr <= 0.05, na.rm = TRUE) / length(sim_mult2$srmr), 
             sum(sim_mult2$srmr <= 0.1, na.rm = TRUE) / length(sim_mult2$srmr)),
    nnfi = c(sum(sim_mult2$nnfi >= 0.97, na.rm = TRUE) / length(sim_mult2$nnfi), 
             sum(sim_mult2$nnfi >= 0.95, na.rm = TRUE) / length(sim_mult2$nnfi)),
    cfi = c(sum(sim_mult2$cfi >= 0.97, na.rm = TRUE) / length(sim_mult2$cfi), 
            sum(sim_mult2$cfi >= 0.95, na.rm = TRUE) / length(sim_mult2$cfi)),
    effect = c(mean(sim_mult2$effectall),
               mean(sim_mult2$effectall)),
    good = sum(sim_mult$pass == "Good", na.rm = TRUE) / length(sim_mult$pass),
    acceptable = (sum(sim_mult$pass == "Acceptable", na.rm = TRUE) +  sum(sim_mult$pass == "Good", na.rm = TRUE)) / length(sim_mult$pass)
  )
  rownames(fit_mult) <- c("good", "acceptable")
  return(fit_mult)
}

extractor <- function(data){
  all_data <- data.frame()
  for (i in 1:length(data)){
    name <- names(data[i])
    chip_good <- data[[i]][1, 2]
    chip_acc <- data[[i]][2, 2]
    rmsea_good <- data[[i]][1, 3]
    rmsea_acc <- data[[i]][2, 3]
    srmr_good <- data[[i]][1, 5]
    srmr_acc <- data[[i]][2, 5]
    nnfi_good <- data[[i]][1, 6]
    nnfi_acc <- data[[i]][2, 6]
    cfi_good <- data[[i]][1, 7]
    cfi_acc <- data[[i]][2, 7]
    effect <- data[[i]][1, 8]
    good <- data[[i]][1, 9]
    acceptable <- data[[i]][1, 10]
    first_data <- data.frame(name = name,
                              chip_good = chip_good,
                              chip_acc = chip_acc,
                              rmsea_good = rmsea_good,
                              rmsea_acc = rmsea_acc,
                              srmr_good = srmr_good,
                              srmr_acc = srmr_acc,
                              nnfi_good = nnfi_good,
                              nnfi_acc = nnfi_acc,
                              cfi_good = cfi_good,
                              cfi_acc = cfi_acc,
                              effect = effect,
                              overall_good = good,
                              overall_acceptable = acceptable
                             )
    all_data <- rbind(all_data, first_data)                
  }
  all_data2 <- all_data %>%
    separate(name, c("mag", "sample_size"), sep = "_") %>%
    mutate(mag = as.numeric(substr(mag, 2, nchar(mag))),
           sample_size = as.numeric(sample_size)) %>%
    pivot_longer(cols = c("chip_good",
                          "chip_acc",
                          "rmsea_good",
                          "rmsea_acc",
                          "srmr_good",
                          "srmr_acc",
                          "nnfi_good",
                          "nnfi_acc",
                          "cfi_good",
                          "cfi_acc",
                          "overall_good",
                          "overall_acceptable"),
                 names_to = "fit_measures",
                 values_to = "prop_passing") %>%
    mutate(effect = effect * -100)
  #separate(prop_passing, c("measure", "goodness_of_fit", sep = "_"))
  return(all_data2)
}

plotter <- function(data){
  ggplot(data = data, aes(x = effect, y = prop_passing, colour = sample_size)) +
    geom_point(position = position_jitter(width = 0.05, height = 0.05)) +
    ylim(-0.1, 1.1) +
    xlab("% change in sepsis rates as a result of intervention") +
    ylab("% simulations fitting (either acceptable or good fit)") +
    facet_wrap(~fit_measures, ncol = 2,
                   labeller = labeller(fit_measures = 
                                        c("cfi_acc" = "CFI, acceptable fit",
                                        "cfi_good" = "CFI, good fit",
                                        "chip_acc" = "Chi squared, acceptable fit",
                                        "chip_good" = "Chi square, good fit",
                                        "nnfi_acc" = "NNFI, acceptable fit",
                                        "nnfi_good" = "NNFI, good fit",
                                        "overall_acceptable" = "Overall, acceptable fit",
                                        "overall_good" = "Overall, good fit",
                                        "rmsea_acc" = "RMSEA, acceptable fit",
                                        "rmsea_good" = "RMSEA, good fit",
                                        "srmr_acc" = "SRMR, acceptable fit",
                                        "srmr_good" = "SRMR, good fit"))) +
    scale_color_viridis_c(option = "C", direction = -1,
                          name = "Sample size (weeks)")
}

plotter2 <- function(data){
  ggplot(data = data, aes(x = sample_size, y = prop_passing)) +
    geom_point() +
    ylim(-0.1, 1.1) +
    xlab("Sample size") +
    ylab("% simulations fitting (either acceptable or good fit)") +
    facet_wrap(~fit_measures, ncol = 2,
                   labeller = labeller(fit_measures = 
                                        c("cfi_acc" = "CFI, acceptable fit",
                                        "cfi_good" = "CFI, good fit",
                                        "chip_acc" = "Chi squared, acceptable fit",
                                        "chip_good" = "Chi square, good fit",
                                        "nnfi_acc" = "NNFI, acceptable fit",
                                        "nnfi_good" = "NNFI, good fit",
                                        "overall_acceptable" = "Overall, acceptable fit",
                                        "overall_good" = "Overall, good fit",
                                        "rmsea_acc" = "RMSEA, acceptable fit",
                                        "rmsea_good" = "RMSEA, good fit",
                                        "srmr_acc" = "SRMR, acceptable fit",
                                        "srmr_good" = "SRMR, good fit"))) +
    scale_color_viridis_c(option = "C", direction = -1,
                          name = "Sample size (weeks)")
}

runit <- function(func){
  
  #nine months
  sim_0_39 <- sim_sorting(func = func, reps = 100, mag = 0, size = 39)
  sim_1_39 <- sim_sorting(func = func, reps = 100, mag = 1, size = 39)
  sim_2_39 <- sim_sorting(func = func, reps = 100, mag = 2.5, size = 39)
  sim_4_39 <- sim_sorting(func = func, reps = 100, mag = 4, size = 39)
  sim_6_39 <- sim_sorting(func = func, reps = 100, mag = 6, size = 39)
  sim_9_39 <- sim_sorting(func = func, reps = 100, mag = 9, size = 39)

  
  #one year
  sim_0_52 <- sim_sorting(func = func, reps = 100, mag = 0, size = 52)
  sim_1_52 <- sim_sorting(func = func, reps = 100, mag = 1, size = 52)
  sim_2_52 <- sim_sorting(func = func, reps = 100, mag = 2.5, size = 52)
  sim_4_52 <- sim_sorting(func = func, reps = 100, mag = 4, size = 52)
  sim_6_52 <- sim_sorting(func = func, reps = 100, mag = 6, size = 52)
  sim_9_52 <- sim_sorting(func = func, reps = 100, mag = 9, size = 52)

  #18 months
  sim_0_78 <- sim_sorting(func = func, reps = 100, mag = 0, size = 78)
  sim_1_78 <- sim_sorting(func = func, reps = 100, mag = 1, size = 78)
  sim_2_78 <- sim_sorting(func = func, reps = 100, mag = 2.5, size = 78)
  sim_4_78 <- sim_sorting(func = func, reps = 100, mag = 4, size = 78)
  sim_6_78 <- sim_sorting(func = func, reps = 100, mag = 6, size = 78)
  sim_9_78 <- sim_sorting(func = func, reps = 100, mag = 9, size = 78)


  #four years
  sim_0_208 <- sim_sorting(func = func, reps = 100, mag = 0, size = 208)
  sim_1_208 <- sim_sorting(func = func, reps = 100, mag = 1, size = 208)
  sim_2_208 <- sim_sorting(func = func, reps = 100, mag = 2.5, size = 208)
  sim_4_208 <- sim_sorting(func = func, reps = 100, mag = 4, size = 208)
  sim_6_208 <- sim_sorting(func = func, reps = 100, mag = 6, size = 208)
  sim_9_208 <- sim_sorting(func = func, reps = 100, mag = 9, size = 208)

  sim_data <- list(s0_39 = sim_0_39, 
                 s1_39 = sim_1_39, 
                 s2_39 = sim_2_39, 
                 s4_39 = sim_4_39, 
                 s6_39 = sim_6_39,
                 s9_39 = sim_9_39,
                 s0_52 = sim_0_52, 
                 s1_52 = sim_1_52, 
                 s2_52 = sim_2_52, 
                 s4_52 = sim_4_52, 
                 s6_52 = sim_6_52,
                 s9_52 = sim_9_52,
                 s0_78 = sim_0_78, 
                 s1_78 = sim_1_78, 
                 s2_78 = sim_2_78, 
                 s4_78 = sim_4_78, 
                 s6_78 = sim_6_78,
                 s9_78 = sim_9_78,
                 s0_208 = sim_0_208, 
                 s1_208 = sim_1_208, 
                 s2_208 = sim_2_208, 
                 s4_208 = sim_4_208, 
                 s6_208 = sim_6_208,
                 s9_208 = sim_9_208)
  
  return(sim_data)
}

runeffect <- function(func){
 mag <- c(rep(5, 9),
          rep(10, 9),
          rep(15, 9))
 micro_scale <- rep(c(0.5, 0.5, 0.5,
                      1, 1, 1,
                      1.2, 1.2, 1.2), 3)
 sepsis_scale = rep(c(1, 0.87, 0.75), 9)
  
 all_runs <- mapply(FUN = sim_sorting, 
                    mag = mag, 
                    micro_scale = micro_scale,
                    sepsis_scale = sepsis_scale,
                    MoreArgs = list(reps = 100, size = 52, func = sem_env_effects))
 
  all_data <- data.frame()
  for (i in 1:ncol(all_runs)){
    #name <- names(data[i])
    chip_good <- all_runs[2, ][[i]][1]
    chip_acc <- all_runs[2, ][[i]][2]
    rmsea_good <- all_runs[3, ][[i]][1]
    rmsea_acc <- all_runs[3, ][[i]][2]
    srmr_good <- all_runs[5, ][[i]][1]
    srmr_acc <- all_runs[5, ][[i]][2]
    nnfi_good <- all_runs[6, ][[i]][1]
    nnfi_acc <- all_runs[6, ][[i]][2]
    cfi_good <- all_runs[7, ][[i]][1]
    cfi_acc <- all_runs[7, ][[i]][2]
    effect <- all_runs[8, ][[i]][1]
    good <- all_runs[9, ][[i]][1]
    acceptable <- all_runs[10, ][[i]][1]
    first_data <- data.frame( chip_good = chip_good,
                              chip_acc = chip_acc,
                              rmsea_good = rmsea_good,
                              rmsea_acc = rmsea_acc,
                              srmr_good = srmr_good,
                              srmr_acc = srmr_acc,
                              nnfi_good = nnfi_good,
                              nnfi_acc = nnfi_acc,
                              cfi_good = cfi_good,
                              cfi_acc = cfi_acc,
                              effect = effect,
                              overall_good = good,
                              overall_acceptable = acceptable
                             )
    all_data <- rbind(all_data, first_data)                
  }
  all_data2 <- cbind(mag, micro_scale, sepsis_scale, all_data)
  all_data3 <- all_data2 %>%
    pivot_longer(cols = c("chip_good",
                          "chip_acc",
                          "rmsea_good",
                          "rmsea_acc",
                          "srmr_good",
                          "srmr_acc",
                          "nnfi_good",
                          "nnfi_acc",
                          "cfi_good",
                          "cfi_acc",
                          "overall_good",
                          "overall_acceptable"),
                 names_to = "fit_measures",
                 values_to = "prop_passing") %>%
    mutate(effect = effect * -100)
  #separate(prop_passing, c("measure", "goodness_of_fit", sep = "_"))
  return(all_data3)
}
  
```


Things to do: 


 - Refine effect size
       - Problem is - want to present it as an absolute risk reduction - however only have a regression co-efficient, how to convert this to an absolute risk reduction
 - Look at larger sample size for misspecified model
 - Try leaving out more covariance relationships than just one
 - Complete questions
 - Tidy up multivariate simulations - it is currently not accurate


## Research questions

 1) Do IPC interventions have an effect on sepsis? If so, which ones? And how much? 
      a) Linear regression of IPC interventions on sepsis
 2) Is the cleanliness of specific ward "areas" more closely associated with the risk of sepsis? Is the cleanliness of specific ward "areas" more closely associated with specific IPC interventions? 
      a) SEM
 3) Are measures of IPC fidelity adequate for understanding how well protected babies are from sepsis? 
      a) PGFI/AIC of models including microbiology, fidelity or IPC
 4) Are there specific fidelity or microbiology thresholds we should be aiming for?
      a) Work back from SEM results. Aim for a specific HAI rate then work back to fidelity and microbiology. 
      
      
## Decision rules for accepting models

I will look at the following fit metrics to determine whether the models have good or acceptable fit for the data. 

Good fit: 
 
	Chi squared p value ≥ 0.05
	AND
	RMSEA ≤ 0.05 AND SRMR ≤ 0.1 OR SRMR ≤ 0.05 AND RMSEA ≤ 0.1
	AND
	CFI ≥ 0.97 AND NNFI ≥ 0.9 OR NNFI ≥ 0.97 AND CFI ≥ 0.9

 
Acceptable fit:

	Chi squared p value ≥ 0.01
	AND
	RMSEA ≤ 0.08 AND SRMR ≤ 0.1 OR SRMR ≤ 0.08 AND RMSEA ≤ 0.1
	AND
	CFI ≥ 0.95 AND NNFI ≥ 0.9 OR NNFI ≥ 0.95 AND CFI ≥ 0.9
	
Though the following measures won't be used to determine whether the model fits or not, I will also report the Chi-squared, with degrees of freedom and p value, the RMSEA with it's interval and the PNFI. 
	
The most stringent accepted fit metrics are: 

 - Chi squared p value - >= 0.05 (good), >= 0.01 (acceptable)
 - RMSEA - <= 0.05 (good), <= 0.08 (acceptable)
 - SRMR - <= 0.05 (good), <= 0.1 (acceptable)
 - CFI - >= 0.97 (good), >= 0.95 (acceptable)
 - NNFI - >= 0.97 (good), >= 0.95 (acceptable)

However, some investigators use less stringent metrics. 

### This is the basic model for environmental SEM

```{r complex, echo = FALSE, warning = FALSE, message = FALSE}
#simulating data ----
sem_env_basic <- function(x, size = 52, baseline = 20, mag = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(20, 10, 
                      10, 20), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(20, 10, 10, 
                        10, 20, 10, 
                        10, 10, 20), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * mag + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * mag + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot, micro_floor, micro_surf, micro_staff, micro_mat)) * 5
  prop <- (micro_cot + micro_floor + micro_surf + micro_staff + micro_mat) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


#this function runs the simulator for different parameters
list_env <- runit(sem_env_basic)

#this function extracts the data from it
data_env <- extractor(list_env)

#this function plots the data
plotter(data_env)

```
### This now looks at the effects of changing the effect size of different components of the model on the proportion of simulations accepted

```{r effect size, echo = FALSE, warning = FALSE, message = FALSE}

##first looking for the effect of interventions on fidelity
#this function simulates two situations where ipc interventions are either on or off and calculates the difference
fid_test <- function(size, baseline, mag) {
  intoff <- c(rep(0, size))
  inton <- c(rep(1, size))
  
  linkon <- inton * mag + baseline
  linkoff <- intoff * mag + baseline
  
  fidon <- rbeta(size, linkon, 100 - linkon)
  fidoff <- rbeta(size, linkoff, 100 - linkoff)
  difference <- mean(fidon) - mean(fidoff)
  
  return(difference)
}

#this function runs this simulation 10000 times
tester_fid <- function(func, size, baseline, mag, repeats){
  all <- c()
  for(i in 1:repeats){
    result <- func(size = size, baseline = baseline, mag = mag)
    all <- c(all, result)
  }
  average <- mean(all)
  return(average)
}

#small effect size
small_fid <- tester_fid(func = fid_test, size = 52, baseline = 10, mag = 5, repeats = 10000)

#moderate effect size
mod_fid <- tester_fid(func = fid_test, size = 52, baseline = 10, mag = 15, repeats = 10000)

#large effect size
large_fid <- tester_fid(func = fid_test, size = 52, baseline = 10, mag = 25, repeats = 10000)

#now looking at the effect of fidelity changes on microbiology
micro_test <- function(size, baseline, increase, scale = 1){
  fidon <- rep(baseline + increase, size)
  fidoff <- rep(baseline, size)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * scale * 100, (1 - y) * scale * 100, 
                                     (1 - a )* scale * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }

  sigma_3 <- matrix(c(20, 10, 10, 
                    10, 20, 10, 
                    10, 10, 20), ncol = 3)

  mv_envon <- mapply(FUN = mv_3, x = fidon, y = fidoff, 
                 a = fidoff, MoreArgs = list(sigma = sigma_3))
  
  mv_envoff <- mapply(FUN = mv_3, x = fidoff, y = fidoff, 
                      a = fidoff, MoreArgs = list(sigma = sigma_3))
  
  micro_on <- mv_envon[1, ]
  micro_off <- mv_envoff[1, ]
  
  microdiff <- mean(micro_on) - mean(micro_off)
  return(microdiff)
}

#this function runs this simulation 10000 times
tester_micro <- function(func, size, baseline, increase, scale, repeats){
  all <- c()
  for(i in 1:repeats){
    result <- func(size = size, baseline = baseline, increase = increase, scale = scale)
    all <- c(all, result)
  }
  average <- mean(all)
  return(average)
}

#this is the effect of fidelity on micro
#small effect size
small_micro <- tester_micro(micro_test, size = 52, baseline = 0.5, increase = 0.1, scale = 0.5, repeats = 100)

#moderate effect size
mod_micro <- tester_micro(micro_test, size = 52, baseline = 0.5, increase = 0.1, scale = 1, repeats = 100)

#large effect size
large_micro <- tester_micro(micro_test, size = 52, baseline = 0.5, increase = 0.1, scale = 1.5, repeats = 100)

##now looking at the effect of microbiology changes on sepsis

sepsis_test <- function(size, baseline, decrease, scale){
  num <- rpois(size, 100)
  max <- (baseline + 10) * 5
  propon <- (((baseline * 4) + (baseline - decrease) * scale) / (max * 2))
  propoff <- baseline * 5 / (max * 2)
  sepsison <- rbinom(size, num, propon) / num
  sepsisoff <- rbinom(size, num, propoff) / num
  sepsisdiff <- mean(sepsisoff) - mean(sepsison)
  return(sepsisdiff)
}

#repeats multiple times
tester_sepsis <- function(func, size, baseline, decrease, scale, repeats){
  all <- c()
  for(i in 1:repeats){
    result <- func(size = size, baseline = baseline, decrease = decrease, scale = scale)
    all <- c(all, result)
  }
  average <- mean(all)
  return(average)
}

#the effect of change in 1 micro parameter on sepsis
#small effect
small_sepsis <- tester_sepsis(func = sepsis_test, size = 52, baseline = 90, decrease = 10, scale = 1, repeats = 10000)

#moderate effect
mod_sepsis <- tester_sepsis(func = sepsis_test, size = 52, baseline = 90, decrease = 10, scale = 0.87, repeats = 10000)

#large effect
large_sepsis <- tester_sepsis(func = sepsis_test, size = 52, baseline = 90, decrease = 10, scale = 0.75, repeats = 10000)

#simulating data ----
sem_env_effects <- function(x, size = 52, baseline = 20, mag = 10, micro_scale, sepsis_scale){
  
  mv_2 <- function(x, y, sigma = sigma_2, mv_scale = micro_scale, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * mv_scale * 100, (1 - y) * mv_scale * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(20, 10, 
                      10, 20), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, mv_scale = micro_scale, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * mv_scale * 100, (1 - y) * mv_scale * 100, 
                                     (1 - a) * mv_scale * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(20, 10, 10, 
                        10, 20, 10, 
                        10, 10, 20), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * mag + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * mag + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot, micro_floor, micro_surf, micro_staff, micro_mat)) * 5
  prop <- (micro_cot + micro_floor + micro_surf + micro_staff + micro_mat) * sepsis_scale / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


#this function runs the simulator for different parameters
data_effects <- runeffect(sem_env_effects)

effects <- data_effects %>%
  filter(fit_measures == "overall_good") %>%
  mutate(micro_scale = as.character(micro_scale))

ggplot(data = effects, aes(x = micro_scale, y = mag, fill = prop_passing)) +
  geom_tile() +
  facet_grid( ~ sepsis_scale) +
  scale_fill_viridis_c(option = "C")

```

This chunk of code first calculates what the effect of changes in different variables have on the next layer in the model. The scale of the effect has been manipulated so that we can make a small effect, moderate effect or large effect. 

IPC -> Fidelity

This is the effect of changing one IPC intervention from 0 to 1 on the fidelity of a single domain. 

Small effect: `r small_fid`
Moderate effect: `r mod_fid`
Large effect: `r large_fid`

Fidelity -> Micro

This is the effect of improving fidelity in one domain by 10% on the microbiology of that same domain.

Small effect: `r small_micro`
Moderate effect: `r mod_micro`
Large effect: `r large_micro`

Micro -> Sepsis

This is the effect of reducing the contamination of one domain by 10% on the proportion of neonates with sepsis. 

Small effect: `r small_sepsis`
Moderate effect: `r mod_sepsis`
Large effect: `r large_sepsis` 


### This is improving it by modelling the maternal and hand hygiene as covariant

```{r improvements, echo = FALSE, warning = FALSE, message = FALSE}
#simulating data ----
sem_env_improved <- function(x, size = 52, baseline = 20, mag = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(20, 10, 
                      10, 20), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(20, 10, 10, 
                        10, 20, 10, 
                        10, 10, 20), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * mag + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * mag + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, 50, 50)
  fid_staff <- rbeta(size, 50, 50)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  #mv_hands <- round(rmvnorm(size, mean = c(50, 50), sigma = sigma_2))
  mv_hands <- mapply(FUN = mv_2, x = fid_mat, y = fid_staff, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot, micro_floor, micro_surf, micro_staff, micro_mat)) * 5
  prop <- (micro_cot + micro_floor + micro_surf + micro_staff + micro_mat) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
    micro_mat ~~ micro_staff
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


#this function runs the simulator for different parameters
list_env_improved <- runit(sem_env_improved)

#this function extracts the data from it
data_env_improved <- extractor(list_env_improved)

#this function plots the data
plotter(data_env_improved)

```


### Question 1: Do IPC interventions have an effect on sepsis? If so which ones? And how much? 


We will fit an SEM model as illustrated above. However, alongside this we will also perform a standard linear regression of different IPC measures against sepsis. This will tell us the relationship between such measures and the rates of sepsis. 


### Question 2: Is the cleanliness of specific ward "areas" more closely associated with the risk of sepsis? Is the cleanliness of specific ward "areas" more closely associated with specific IPC interventions? 

Looking at this would allow us to determine which areas are most useful for intervention. If specific ward areas are most associated with sepsis and it is clear which interventions affect these primarily, then these areas can be targeted with interventions that are most likely to be effective.

To determine how well the model will be at identifying individual ward areas as responsible for decreases in sepsis I will alter some of the relationships in the model. 

#### First a model where only one area has an effect on sepsis. 

In this model, only cot contamination has any effect on sepsis. All other variables have no effect. 

```{r one area, echo = FALSE, warning = FALSE, message = FALSE}
#simulating data ----
sem_env_onearea <- function(x, size = 52, baseline = 20, mag = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(4, 2, 
                      2, 4), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(4, 2, 2, 
                        2, 4, 2, 
                        2, 2, 4), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * mag + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * mag + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot))
  prop <- (micro_cot) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


sim_onearea <- runit(sem_env_onearea)

data_env <- extractor(sim_onearea)

plotter(data_env)

```

It looks therefore like specifying relationships that are not there will not lead to the model being rejected, however the magnitude of the coefficients will show whether there is a meaningful effect or not. In this example this is illustrated by the magnitude of effect between micro_cot and sepsis `r sem_env_onearea(1)$sepsis_._micro_cot` (variable for which there is a simulated relationship) and micro_surf and sepsis `r sem_env_onearea(1)$sepsis_._micro_surf` (variable for which there is no simulated relationship).

#### Next a model where only one IPC intervention has any relationships

In this model, only one IPC intervention has any effect on fidelity.

```{r one ipc, echo = FALSE, warning = FALSE, message = FALSE}
#simulating data ----
sem_env_oneipc <- function(x, size = 52, baseline = 20, mag = 10){
  
  mv_2 <- function(x, y, sigma = sigma_2, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100), sigma = sigma_2)
    param <- round(param)
    return(param)
  }
  
  #covariance matrix
  sigma_2 <- matrix(c(4, 2, 
                      2, 4), ncol = 2)
  
  mv_3 <- function(x, y, a, sigma = sigma_3, ...){
    param <- rmvnorm(n = 1, mean = c((1 - x) * 100, (1 - y) * 100, 
                                     (1 - a) * 100), sigma = sigma_3)
    param <- round(param)
    return(param)
  }
  
    sigma_3 <- matrix(c(4, 2, 2, 
                        2, 4, 2, 
                        2, 2, 4), ncol = 3)
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #hands
  int_h1 <- c(rep(0, round(size / 4)), rep(1, size - round(size / 4)))
  int_h2 <- c(rep(0, size - round(size / 3)), rep(1, round(size / 3)))
  int_h3 <- c(rep(0, round(size / 4 * 3)), rep(1, size - round(size / 4 * 3)))
  num_hands <- (int_h1 + int_h2 + int_h3) * mag + baseline
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e2) * mag + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, num_env, 100 - num_env)
  fid_floor <- rbeta(size, num_env, 100 - num_env)
  fid_surf <- rbeta(size, num_env, 100 - num_env)
  #hands
  fid_mat <- rbeta(size, num_hands, 100 - num_hands)
  fid_staff <- rbeta(size, num_hands, 100 - num_hands)
  #microbiology
  #environmental
  mv_env <- mapply(FUN = mv_3, x = fid_cot, y = fid_floor, 
                   a = fid_surf, MoreArgs = list(sigma = sigma_3))
  micro_cot <- mv_env[1, ]
  micro_floor <- mv_env[2, ]
  micro_surf <- mv_env[3, ]
  #hands
  mv_hands <- mapply(FUN = mv_2, x = fid_staff, y = fid_mat, MoreArgs = list(sigma = sigma_2))
  micro_staff <- mv_hands[1, ]
  micro_mat <- mv_hands[2, ]
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  max <- max(c(micro_cot))
  prop <- (micro_cot) / (max * 2)
  sepsis <- rbinom(size, num, prop) / num
  
  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    int_h1 = int_h1,
    int_h2 = int_h2,
    int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    fid_mat = fid_mat,
    fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- as.data.frame(apply(df_ipc, 2, scale))
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3, data = df2)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass = pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}


sim_oneipc <- runit(sem_env_oneipc)

data_oneipc <- extractor(sim_oneipc)

plotter(data_oneipc)

```



### Question 3: Are measures of IPC fidelity adequate for understanding how well protected babies are from sepsis?


### Question 4: Are there specific fidelity or microbiology thresholds we should be aiming for?


### This is a simulation of a model that is completely independent

There are no relationships between any of the variables for this model, however, certain fit measures accept it. If you use the decision rule for overall passing or failing though, it is never accepted. That is why it is important to retain all of the fit measures when judging the models. 

``` {r  completely independent model,  echo = FALSE, warning = FALSE, message = FALSE}

#simulating data ----
sem_env_ci <- function(x, size = 52, baseline = 20, mag = 10){

  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  #environment
  int_e1 <- c(rep(0, round(size / 3)), rep(1, size - round(size / 3)))
  int_e2 <- c(rep(0, round(size / 2)), rep(1, size - round(size / 2)))
  int_e3 <- c(rep(0, round(size / 10 * 2)), rep(1, size - round(size / 10 * 2)))
  num_env <- (int_e1 + int_e2 + int_e3) * mag + baseline
  #simulating fidelity of intervention
  #overall environmental
  fid_cot <- rbeta(size, 50, 50)
  fid_floor <- rbeta(size, 50, 50)
  fid_surf <- rbeta(size, 50, 50)
  #hands
  #microbiology
  #environmental
  micro_cot <- round(rnorm(size, mean = 50, sd = 2))
  micro_floor <- round(rnorm(size, mean = 50, sd = 2))
  micro_surf <- round(rnorm(size, mean = 50, sd = 2))
  micro_staff <- round(rnorm(size, mean = 50, sd = 2))
  micro_mat <- round(rnorm(size, mean = 50, sd = 2))
  #sepsis
  #number of neonates
  num <- rpois(size, 100)
  prop <- 0.3
  sepsis <- rbinom(size, num, prop) / num

  #creating data frame
  df_ipc <- data.frame(
    #weeks = weeks,
    int_e1 = int_e1,
    int_e2 = int_e2,
    int_e3 = int_e3,
    #int_h1 = int_h1,
    #int_h2 = int_h2,
    #int_h3 = int_h3,
    fid_cot = fid_cot,
    fid_floor = fid_floor,
    fid_surf = fid_surf,
    #fid_mat = fid_mat,
    #fid_staff = fid_staff,
    micro_cot = micro_cot,
    micro_floor = micro_floor,
    micro_surf = micro_surf,
    micro_staff = micro_staff,
    micro_mat = micro_mat,
    sepsis = sepsis
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    #regressions
    fid_cot ~ int_e1 + int_e2 + int_e3
    fid_floor ~ int_e1 + int_e2 + int_e3
    fid_surf ~ int_e1 + int_e2 + int_e3
    
    micro_cot ~ fid_cot
    micro_floor ~ fid_floor
    micro_surf ~ fid_surf

    sepsis ~ micro_cot + micro_floor + micro_surf + micro_mat + micro_staff
    
    #covariance
    micro_cot ~~ micro_floor
    micro_cot ~~ micro_surf
    micro_floor ~~ micro_surf
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2,
                           effect1 = effect$coefficients[2],
                           effect2 = effect$coefficients[3],
                           effect3 = effect$coefficients[4],
                           effectall = mean(c(effect$coefficients[2], effect$coefficients[3], effect$coefficients[4]))
  ))
  rownames(data) <- c()
  return(data)
}

#one year
sim_2_52_ci <- sim_sorting(func = sem_env_ci, reps = 100, mag = 2)

#18 months
sim_2_78_ci <- sim_sorting(func = sem_env_ci, reps = 100, mag = 2, size = 78)


#four years
sim_2_208_ci <- sim_sorting(func = sem_env_ci, reps = 100, mag = 2, size = 208)

sim_data_ci <- list(s2_52 = sim_2_52_ci, 
                 s2_78 = sim_2_78_ci, 
                 s2_208 = sim_2_208_ci)

data_ci <- extractor(sim_data_ci)

plotter2(data_ci)

```

### Exploring the limits of independent models

Following are some models which are independent and very simple. 

#### This model has just one relationship - 0 degrees of freedom

``` {r completely independent 1,  echo = FALSE, warning = FALSE, message = FALSE}

#simulating data ----
sem_env_ci1 <- function(x, size = 52, baseline = 20, mag = 10){
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  a1 <- rnorm(size, 50, 10)
  a2 <- rnorm(size, 50, 10)
  a3 <- rnorm(size, 50, 10)
  
  b1 <- rnorm(size, 50, 10)
  b2 <- rnorm(size, 50, 10)
  b3 <- rnorm(size, 50, 10)
  b4 <- rnorm(size, 50, 10)
  
  c1 <- rnorm(size, 50, 10)
  c2 <- rnorm(size, 50, 10)
  c3 <- rnorm(size, 50, 10)
  c4 <- rnorm(size, 50, 10)
  
  s1 <- rnorm(size, 50, 10)
  
  
  
  #creating data frame
  df_ipc <- data.frame(
    a1 = a1,
    a2 = a2,
    a3 = a3,
    b1 = b1,
    b2 = b2,
    b3 = b3,
    b4 = b4,
    c1 = c1, 
    c2 = c2,
    c3 = c3,
    c4 = c4,
    s1 = s1
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    a1 ~ a2
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  #effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2))
  rownames(data) <- c()
  return(data)
}

#one year
sim_52_ci1 <- sim_sorting(func = sem_env_ci1, reps = 100)

#18 months
sim_78_ci1 <- sim_sorting(func = sem_env_ci1, reps = 100,size = 78)

#four years
sim_208_ci1 <- sim_sorting(func = sem_env_ci1, reps = 100, size = 208)

sim_data_ci1 <- list(s_52 = sim_52_ci1,
                    s_78 = sim_78_ci1,
                    s_208 = sim_208_ci1)

data_ci1 <- extractor(sim_data_ci1)

plotter2(data_ci1)

#reporting the degrees of freedom
df <- sem_env_ci1(1)[, "df"]
print("Degrees of Freedom:")
print(df)
```

Strangely Chi squared does not fit for this model at all. It is because it has 0 degrees of freedom. This means that the model is just-identified and Chi-squared does not work. 

#### This model has more variables but also 0 degrees of freedom

This is the model:

c1 ~ b1 + b2
c2 ~ b2 + b1

Degrees of freedom for this is 0. The same as the model above with only 1 relationship. It also has a similar effect as with the previous model. 

``` {r completely independent degrees freedom 0,  echo = FALSE, warning = FALSE, message = FALSE}

#simulating data ----
sem_env_ci0 <- function(x, size = 52, baseline = 20, mag = 10){
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  a1 <- rnorm(size, 50, 10)
  a2 <- rnorm(size, 50, 10)
  a3 <- rnorm(size, 50, 10)
  
  b1 <- rnorm(size, 50, 10)
  b2 <- rnorm(size, 50, 10)
  b3 <- rnorm(size, 50, 10)
  b4 <- rnorm(size, 50, 10)
  
  c1 <- rnorm(size, 50, 10)
  c2 <- rnorm(size, 50, 10)
  c3 <- rnorm(size, 50, 10)
  c4 <- rnorm(size, 50, 10)
  
  s1 <- rnorm(size, 50, 10)
  
  
  
  #creating data frame
  df_ipc <- data.frame(
    a1 = a1,
    a2 = a2,
    a3 = a3,
    b1 = b1,
    b2 = b2,
    b3 = b3,
    b4 = b4,
    c1 = c1, 
    c2 = c2,
    c3 = c3,
    c4 = c4,
    s1 = s1
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    c1 ~ b1 + b2
    c2 ~ b2 + b1
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  #effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2))
  rownames(data) <- c()
  return(data)
}

#one year
sim_52_ci0 <- sim_sorting(func = sem_env_ci0, reps = 100)

#18 months
sim_78_ci0 <- sim_sorting(func = sem_env_ci0, reps = 100,size = 78)

#four years
sim_208_ci0 <- sim_sorting(func = sem_env_ci0, reps = 100, size = 208)

sim_data_ci0 <- list(s_52 = sim_52_ci0,
                    s_78 = sim_78_ci0,
                    s_208 = sim_208_ci0)

data_ci0 <- extractor(sim_data_ci0)

plotter2(data_ci0)

#reporting the degrees of freedom
df <- sem_env_ci0(1)[, "df"]
print("Degrees of Freedom:")
print(df)
```


#### This model has two relationships

``` {r completely independent 2,  echo = FALSE, warning = FALSE, message = FALSE}

#simulating data ----
sem_env_ci2 <- function(x, size = 52, baseline = 20, mag = 10){
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  a1 <- rnorm(size, 50, 10)
  a2 <- rnorm(size, 50, 10)
  a3 <- rnorm(size, 50, 10)
  
  b1 <- rnorm(size, 50, 10)
  b2 <- rnorm(size, 50, 10)
  b3 <- rnorm(size, 50, 10)
  b4 <- rnorm(size, 50, 10)
  
  c1 <- rnorm(size, 50, 10)
  c2 <- rnorm(size, 50, 10)
  c3 <- rnorm(size, 50, 10)
  c4 <- rnorm(size, 50, 10)
  
  s1 <- rnorm(size, 50, 10)
  
  
  
  #creating data frame
  df_ipc <- data.frame(
    a1 = a1,
    a2 = a2,
    a3 = a3,
    b1 = b1,
    b2 = b2,
    b3 = b3,
    b4 = b4,
    c1 = c1, 
    c2 = c2,
    c3 = c3,
    c4 = c4,
    s1 = s1
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    c1 ~ b1
    c2 ~ b2
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  #effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2))
  rownames(data) <- c()
  return(data)
}

#one year
sim_52_ci2 <- sim_sorting(func = sem_env_ci2, reps = 100)

#18 months
sim_78_ci2 <- sim_sorting(func = sem_env_ci2, reps = 100,size = 78)

#four years
sim_208_ci2 <- sim_sorting(func = sem_env_ci2, reps = 100, size = 208)

sim_data_ci2 <- list(s_52 = sim_52_ci2,
                    s_78 = sim_78_ci2,
                    s_208 = sim_208_ci2)

data_ci2 <- extractor(sim_data_ci2)

plotter2(data_ci2)

#reporting the degrees of freedom
df <- sem_env_ci2(1)[, "df"]
print("Degrees of Freedom:")
print(df)
```

#### This model has three relationships

``` {r completely independent 3,  echo = FALSE, warning = FALSE, message = FALSE}

#simulating data ----
sem_env_ci3 <- function(x, size = 52, baseline = 20, mag = 10){
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  a1 <- rnorm(size, 50, 10)
  a2 <- rnorm(size, 50, 10)
  a3 <- rnorm(size, 50, 10)
  
  b1 <- rnorm(size, 50, 10)
  b2 <- rnorm(size, 50, 10)
  b3 <- rnorm(size, 50, 10)
  b4 <- rnorm(size, 50, 10)
  
  c1 <- rnorm(size, 50, 10)
  c2 <- rnorm(size, 50, 10)
  c3 <- rnorm(size, 50, 10)
  c4 <- rnorm(size, 50, 10)
  
  s1 <- rnorm(size, 50, 10)
  
  
  
  #creating data frame
  df_ipc <- data.frame(
    a1 = a1,
    a2 = a2,
    a3 = a3,
    b1 = b1,
    b2 = b2,
    b3 = b3,
    b4 = b4,
    c1 = c1, 
    c2 = c2,
    c3 = c3,
    c4 = c4,
    s1 = s1
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    c1 ~ b1
    c2 ~ b2
    c3 ~ b3
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  #effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2))
  rownames(data) <- c()
  return(data)
}

#one year
sim_52_ci3 <- sim_sorting(func = sem_env_ci3, reps = 100)

#18 months
sim_78_ci3 <- sim_sorting(func = sem_env_ci3, reps = 100,size = 78)

#four years
sim_208_ci3 <- sim_sorting(func = sem_env_ci3, reps = 100, size = 208)

sim_data_ci3 <- list(s_52 = sim_52_ci3,
                    s_78 = sim_78_ci3,
                    s_208 = sim_208_ci3)

data_ci3 <- extractor(sim_data_ci3)

plotter2(data_ci3)
```


They all seem to be accepted in certain situations by some of the fit measures (particularly Chi squared and RMSEA), though if you apply the decision rule then none of them are accepted. 

#### This model has mis-specified relationships

``` {r completely independent misspecified,  echo = FALSE, warning = FALSE, message = FALSE}

#simulating data ----
sem_env_mis <- function(x, size = 52, baseline = 20, mag = 10){
  
  #simulating time
  weeks <- seq(1:size)
  #simulating interventions
  a1 <- rnorm(size, 50, 10)
  a2 <- rnorm(size, 50, 10)
  a3 <- rnorm(size, 50, 10)
  a4 <- rnorm(size, 50, 10)
  
  b1 <- a1 + rnorm(size, 0, 1)
  b2 <- a2 + rnorm(size, 0, 1)
  b3 <- a3 + rnorm(size, 0, 1)
  b4 <- a4 + rnorm(size, 0, 1)
  
  c1 <- rnorm(size, 50, 10)
  c2 <- rnorm(size, 50, 10)
  c3 <- rnorm(size, 50, 10)
  c4 <- rnorm(size, 50, 10)
  
  s1 <- rnorm(size, 50, 10)
  
  
  
  #creating data frame
  df_ipc <- data.frame(
    a1 = a1,
    a2 = a2,
    a3 = a3,
    a4 = a4,
    b1 = b1,
    b2 = b2,
    b3 = b3,
    b4 = b4,
    c1 = c1, 
    c2 = c2,
    c3 = c3,
    c4 = c4,
    s1 = s1
  )
  
  df2 <- apply(df_ipc, 2, scale)
  
  #first model ----
  #lavaan formulation without latent variables
  ipc_model <- '
    b1 ~ a2
    b2 ~ a1
    b3 ~ b4
    b4 ~ b3
  '
  
  #fitting the model
  ipc_fit <- sem(ipc_model, data = df2, bounds = TRUE)
  
  #finding the effect size
  #effect <- glm(sepsis ~ int_e1 + int_e2 + int_e3)
  
  #getting the parameter estimates
  params <- try(parameterEstimates(ipc_fit), silent = TRUE) %>%
    filter(op == "~") %>%
    unite(param, c("lhs", "op", "rhs"), remove = FALSE) %>%
    dplyr::select(param, est)
  
  #converting them to the right orientation
  params2 <- t(params$est)
  colnames(params2) <- params$param
  
  #determining whether the simulation would pass the decision rule
  pass <- case_when(isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.05 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.05) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.97 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                      ~ "Good",
                    isTRUE((try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"] >= 0.01) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.08 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.1) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"] <= 0.1 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["srmr"] <= 0.08) &
                    (try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.90) |
                    (try(fitMeasures(ipc_fit), silent = TRUE)["cfi"] >= 0.95 &
                    try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"] >= 0.90))
                    ~ "Acceptable",
                    TRUE ~ "Poor")
  
  #extracting data from the model
  data <- cbind(data.frame(run = x,
                           chisq = try(fitMeasures(ipc_fit), silent = TRUE)["chisq"],
                           df = try(fitMeasures(ipc_fit), silent = TRUE)["df"],
                           pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["pvalue"],
                           rmsea = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea"], 
                           rmsea.ci.lower = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.lower"],
                           rmsea.ci.upper = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.ci.upper"],
                           rmsea.pvalue = try(fitMeasures(ipc_fit), silent = TRUE)["rmsea.pvalue"],
                           srmr = try(fitMeasures(ipc_fit), silent = TRUE)["srmr"],
                           nnfi = try(fitMeasures(ipc_fit), silent = TRUE)["nnfi"],
                           cfi = try(fitMeasures(ipc_fit), silent = TRUE)["cfi"],
                           pass,
                           params2))
  rownames(data) <- c()
  return(data)
}

#one year
sim_52_mis <- sim_sorting(func = sem_env_mis, reps = 100)

#18 months
sim_78_mis <- sim_sorting(func = sem_env_mis, reps = 100,size = 78)

#four years
sim_208_mis <- sim_sorting(func = sem_env_mis, reps = 100, size = 208)

sim_data_mis <- list(s_52 = sim_52_mis,
                    s_78 = sim_78_mis,
                    s_208 = sim_208_mis)

data_mis <- extractor(sim_data_mis)

plotter2(data_mis)
```
